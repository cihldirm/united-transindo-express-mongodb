<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <meta http-equiv="X-UA-Compatible" content="ie=edge" /> -->
    <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="initial-scale=1.0, target-densitydpi=device-dpi" /><!-- this is for mobile (Android) Chrome -->
    <meta name="viewport" content="initial-scale=1.0, width=device-height"><!--  mobile Safari, FireFox, Opera Mobile  -->
    <!-- <script type="text/javascript" src="/vendors/jSignature/libs/modernizr.js"></script> -->
    <title>United Transindo Admin Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/images/icons/Logo United Transindo.ico">
    <!-- core:css -->
    <link rel="stylesheet" href="/vendors/core/core.css" />
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- Bootstrap CSS -->
    <!-- <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Msg CSS -->
    <!-- <link rel="stylesheet" href="/css/bootstrap-msg.css"> -->
    <!-- Font Awesome 4 -->
    <link rel="stylesheet" href="/vendors/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendors/select2/select2.min.css">
    <link rel="stylesheet" href="/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="/vendors/mdi/css/materialdesignicons.min.css">
    <link
      rel="stylesheet"
      href="/vendors/sweetalert2/sweetalert2.min.css"
    />
    <!-- end plugin css for this page -->
    <!-- inject:css -->
    <link
      rel="stylesheet"
      href="/fonts/feather-font/css/iconfont.css"
    />
    <link
      rel="stylesheet"
      href="/vendors/flag-icon-css/css/flag-icon.min.css"
    />
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="/css/demo_1/style.css" />
    
    <!--[if lt IE 9]>
    <script type="text/javascript" src="/vendors/jSignature/libs/flashcanvas.js"></script>
    <![endif]-->
    <style>
      .page-content {
        padding-bottom: 0 !important;
        display: grid;
        flex-grow: unset !important;
      }
      .spinner-border {
        position: absolute;
        top: calc(50% + 30px);
        left: calc(50% + 120px);
      }
      #myList .list-group-item-action {
        &:hover {
          /* z-index: 1; */
          color: #495057;
          text-decoration: none;
          background-color: #f8f9fa;
          cursor: pointer;
        }
        &:focus {
          border: 1px solid rgba(0, 0, 0, 0.125);
          opacity: 0.5;
        }
      }
      .pagination {
        margin: 0;
      }
      .pager .pagination li.page-item.disabled {
        .page-link {
          /* background-color: #e9ecef; */
          background-color: #adb5bd;
          color: rgba(33,37,41,0.75);
        }
      }
    </style>
    <!-- End layout styles -->
    <link
      rel="shortcut icon"
      href="/images/icons/Logo United Transindo.png"
    />
  </head>
  <body>
    <div class="main-wrapper">
      <!-- partial:partials/_sidebar.html -->
      <%- include('./sidebar.ejs') %>
      <!-- partial -->

      <div class="page-wrapper">
        <!-- partial:partials/_navbar.html -->
        <%- include('./navbar.ejs') %>
        <!-- partial -->

        <div class="page-content">
          
          <nav class="page-breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="#"><%= user.role %></a></li>
              <li class="breadcrumb-item active" aria-current="page">
                <%= listType %> Job Order
              </li>
            </ol>
          </nav>

          <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
          </div>

          <div class="row">
            <div class="col-12 col-xl-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body" id="list-content" style="display: none;">
                  <h3><%= listType %> Job Order</h3>
                    <% if (listJobOrder.length) { %>
                      <div id="myList" class="list-group mt-3"></div>
                      <div class="pager mt-5">
                        <ul class="pagination pagination-rounded pagination-sm justify-content-end"></ul>
                      </div>
                    <% } else { %>
                      <div class="content mt-5" style="text-align: center;">
                        There are no records to display <%= listType %> Job Order
                      </div>
                    <% } %>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- partial:partials/_footer.html -->
        <%- include('./footer.ejs') %>
        <!-- partial -->
      </div>
    </div>

    <!-- core:js -->
    <script src="/vendors/core/core.js"></script>
    <!-- endinject -->
    <!-- plugin js for this page -->
    <!-- jQuery -->
    <!-- <script src="/vendors/jSignature/libs/jquery.js"></script> -->
    <script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>
    <!-- <script src="/vendors/jquery.autosize.input/jquery.autosize.input.js"></script> -->
    <!-- Bootstrap JS -->
    <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootsrap Msg Js -->
    <!-- <script src="/js/bootstrap-msg.js"></script> -->
    <!-- <script src="/vendors/chartjs/Chart.min.js"></script>
    <script src="/vendors/jquery.flot/jquery.flot.js"></script>
    <script src="/vendors/jquery.flot/jquery.flot.resize.js"></script>
    <script src="/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script> -->
    <!-- <script src="https://github.com/jquery/jquery-ui/blob/main/ui/i18n/datepicker-id.js" type='text/javascript'></script> -->
    <!-- <script src="/vendors/apexcharts/apexcharts.min.js"></script>
    <script src="/vendors/progressbar.js/progressbar.min.js"></script>
    <script src="/vendors/select2/select2.min.js"></script> -->
    <script src="/vendors/sweetalert2/sweetalert2.min.js"></script>
    <!-- <script src="/vendors/promise-polyfill/polyfill.min.js"></script> -->
    <!-- Optional:  polyfill for ES6 Promises for IE11 and Android browser -->
    <script src="/vendors/moment/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/locale/id.min.js" integrity="sha512-he8U4ic6kf3kustvJfiERUpojM8barHoz0WYpAUDWQVn61efpm3aVAD8RWL8OloaDDzMZ1gZiubF9OSdYBqHfQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- <script src="/vendors/tempusdominus-bootstrap-4/tempusdominus-bootstrap-4.js"></script>
    <script src="/vendors/inputmask/jquery.inputmask.min.js"></script>
    <script src="/vendors/jquery-validation/jquery.validate.min.js"></script> -->
    <!-- <script src="/vendors/jSignature/src/jSignature.js"></script>
    <script src="/vendors/jSignature/src/plugins/jSignature.CompressorBase30.js"></script>
    <script src="/vendors/jSignature/src/plugins/jSignature.CompressorSVG.js"></script>
    <script src="/vendors/jSignature/src/plugins/jSignature.UndoButton.js"></script> 
    <script src="/vendors/jSignature/src/plugins/signhere/jSignature.SignHere.js"></script> 
    <script src="https://willowsystems.github.io/jSignature/js/libs/jSignature.min.js"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js"></script> -->
    <!-- end plugin js for this page -->
    <!-- inject:js -->
    <script src="/vendors/feather-icons/feather.min.js"></script>
    <script src="/js/template.js"></script>
    <!-- endinject -->
    <!-- custom js for this page -->
    <!-- <script src="/js/dashboard.js"></script> -->
    <!-- <script src="/js/datepicker-id.js" charset="UTF-8"></script> -->
    <!-- <script src="/js/datepicker.js"></script> -->
    <!-- <script src="/js/timepicker.js"></script> -->
    <!-- end custom js for this page -->

    <script>
      const listType = "<%= listType %>";
      console.log("listType in list job order = ", listType);

      var listJobOrder = <%- JSON.stringify(listJobOrder) %>;
      console.log("listJobOrder is = ", JSON.stringify(listJobOrder, null, '\t'));

        var pager = {};
        pager.items = listJobOrder;
        pager.itemsPerPage = 3;
        pager.currentPage = 0;
        if (listJobOrder.length > 0) {
          pagerInit(pager);
        }

        function bindList() {
            let pgItems = pager.pagedItems[pager.currentPage];
            $('.pager .pagination li').removeClass('disabled');
            // $(this).not('.prev,.next').addClass('active');
            // $('li.prev').next().addClass('active');
            if (pager.currentPage === 0) {
              $('li.prev').addClass('disabled');
            } 
            if (pager.currentPage + 1 === pager.pagedItems.length) {
              $('li.next').addClass('disabled');
            }
            
            $("#myList").empty();
            for(let i = 0, city; i < pgItems.length; i++){
              switch (pgItems[i].city_code) {
                  case "01":
                      city = "Sidoarjo";
                      break;
                  case "02":
                      city = "Cikarang";
                      break;
                  case "03":
                      city = "Jakarta";
                      break;
                  case "04":
                      city = "Makassar";
                      break;
              }

              let option = `
                <li class="list-group-item list-group-item-action">
                  <div class="d-flex w-100 justify-content-between">
                    <h5 id="no_jo" class="mb-1">Job Order No. ${pgItems[i].city_code + String(moment(new Date(pgItems[i].tgl_wkt_dibuat)).format('YY')) + pgItems[i].no_joj}</h5>
                    <small class="text-muted">${city}, tanggal ${moment(pgItems[i].tgl_wkt_dibuat).format('DD MMMM YYYY')} jam ${moment(pgItems[i].tgl_wkt_dibuat).format('HH:mm')}</small>
                  </div>
                  <div class="d-flex w-100 justify-content-between">
                    <p class="mb-1">Dari ${pgItems[i].nama_pengirim} kepada ${pgItems[i].nama_penerima}</p>
                    <div>
                      <button type="button" id="edit" class="btn btn-warning btn-icon-text">
                        <i data-feather="edit" class="btn-icon-prepend"></i> Edit
                      </button>
                      <button type="button" id="cancel" class="btn btn-danger btn-icon-text">
                        <i data-feather="x-circle" class="btn-icon-prepend"></i> Cancel
                      </button>
                    </div>
                  </div>
                  <small class="text-muted">Pengambilan Unit pada hari ${pgItems[i].hr_tgl_ambil.split(" / ")[0]} tanggal ${pgItems[i].hr_tgl_ambil.split(" / ")[1]}</small>
                </li>
              `;

              // console.log("option is = ", option);

              $("#myList").append(option);

              // Enable feather-icons with SVG markup
              feather.replace();
            }
        }

        // function prevPage(){
        //     pager.prevPage();
        //     bindList();
        // }

        // function nextPage(){
        //     pager.nextPage();
        //     bindList();
        // }

        function pagerInit(p) {
            p.pagedItems = [];
            p.prevPage = function () {
                if (p.currentPage > 0) {
                  $('li.active').removeClass('active').prev().addClass('active');
                    p.currentPage--;
                }
            };
            p.nextPage = function () {
                if (p.currentPage < p.pagedItems.length - 1) {
                  $('li.active').removeClass('active').next().addClass('active');
                    p.currentPage++;
                }
            };
            init = function () {
                $(".pager ul.pagination").empty();
                
                // $(".pager ul.pagination").append('<li class=prev><a href="" aria-label=Previous><span aria-hidden=true>&laquo;</span></a></li>');
                // JSON.stringify(p.pagedItems, null, '\t')
                $(".pager ul.pagination").append(`
                  <li class="page-item prev disabled">
                    <a class="page-link" href="" tabindex="-1" aria-disabled="true">«</a>
                  </li>
                `);
                for (let i = 0; i < p.items.length; i++) {
                  // console.log("Math.floor(i / p.itemsPerPage) = ", Math.floor(i / p.itemsPerPage));
                  // console.log("p.items[i] = ", p.items[i]);
                  if (i % p.itemsPerPage === 0) {
                      p.pagedItems[Math.floor(i / p.itemsPerPage)] = [p.items[i]];
                  } else {
                      p.pagedItems[Math.floor(i / p.itemsPerPage)].push(p.items[i]);
                  }
                  console.log("p.pagedItems = ", JSON.stringify(p.pagedItems, null, '\t'));
                }
                console.log("p.pagedItems final result = ", JSON.stringify(p.pagedItems, null, '\t'));
                for (let index = 1; index <= p.pagedItems.length; index++) {
                  $(".pager ul.pagination").append(`
                    <li class="page-item"><a class="page-link" href="">${index}</a></li>
                  `);
                }
                $(".pager ul.pagination").append(`
                  <li class="page-item next">
                    <a class="page-link" href="">»</a>
                  </li>
                `);
                $('li.prev').next().addClass('active');
            };
            init();
        }

        $(document).ready(function() {
            

            // for (let index = 0; index < waitlistJobOrder.length; index++) {
            //     console.log("index is = ", index);
            //     console.log("waitlistJobOrder is = ", waitlistJobOrder[index]);
            // }

            const loadData = async () => {
              bindList();
              console.log("pager after init ready = ", pager);
            };

            loadData();

            $(".spinner-border").hide();

            $("#list-content").show();

            $('#myList').on('click', 'li.list-group-item-action button#cancel.btn', function(event) {
              event.preventDefault();
              let no_jo = listJobOrder[pager.currentPage * pager.itemsPerPage + $(this).closest("li.list-group-item-action").index()].no_joj;

              const swalWithBootstrapButtons = Swal.mixin({
                customClass: {
                  confirmButton: 'btn btn-success',
                  cancelButton: 'btn btn-danger mr-2'
                },
                buttonsStyling: false,
              })
              
              swalWithBootstrapButtons.fire({
                title: `Continue to Cancel Job Order ${no_jo}?`,
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonClass: 'mr-2',
                confirmButtonText: 'Yes, cancel it',
                cancelButtonText: 'No, back to list',
                reverseButtons: true
              }).then(async(result) => {
                console.log("result = ", result);
                if (result.value) {
                  swalWithBootstrapButtons.fire(
                    'Cancelled!',
                    `Job Order ${no_jo} has been cancelled.`,
                    'success'
                  )
                  const Toast = Swal.mixin({
                    toast: true,
                    position: 'bottom-start',
                    showConfirmButton: false,
                    timer: 5000,
                    timerProgressBar: true,
                  });
                  try {
                    const response = await fetch(`/cancel-job-order/${no_jo}`, {
                      method: "PUT",
                      // body: formData,
                      // body: JSON.stringify({ 
                      //   disetujui_oleh: user.username,
                      //   ttd_disetujui_oleh,
                      // }),
                      headers: {'Content-Type': 'application/json', "Accept":"text/html"},
                      credentials: 'same-origin',
                    });
                    console.log("response of cancelData = ", response);

                    // console.log("response body is = ", response.body);

                    if (response.status == 200 || response.ok) {
                      console.log('Promise resolved and HTTP status is successful');
                      // const result = response.json();
                      // console.log("result from response of cancelData = ", result);
                      
                      let indexJO = listJobOrder.findIndex(jobOrder => jobOrder.no_joj === no_jo);
                      if (indexJO !== -1) {
                        listJobOrder.splice(indexJO, 1);
                        pager.items = listJobOrder;
                        if (listJobOrder.length > 0) {
                          pagerInit(pager);
                        }
                        bindList();
                      }

                      Toast.fire({
                        icon: 'success',
                        html: `<label>Cancel Job Order ${no_jo} Success</label>`,
                      });
                    } else {
                      console.log('error: ', response.status, response.statusText);
                      console.error('Promise resolved but HTTP status failed');
                        
                      Toast.fire({
                        icon: 'error',
                        html: `<label>There are some errors when cancel Job Order ${no_jo}</label>`,
                      });
                      /* Handle the error returned by the HTTP request */
                      return {error: {status: response.status, statusText: response.statusText}};
                    }
                  } catch (err) {
                    console.error(err)
                      
                    Toast.fire({
                      icon: 'error',
                      html: `<label>Submit Form Failed</label>`,
                    });
                  }
                } 
                // else if (
                //   // Read more about handling dismissals
                //   result.dismiss === Swal.DismissReason.cancel
                // ) {
                //   swalWithBootstrapButtons.fire(
                //     'Cancelled',
                //     'Your imaginary file is safe :)',
                //     'error'
                //   )
                // }
              })
              event.stopImmediatePropagation();
            });

            $('#myList').on('click', 'li.list-group-item-action button#edit.btn', function(event) {
              // alert($(this).closest("li.list-group-item-action").index());
              event.preventDefault();
              let no_jo = listJobOrder[pager.currentPage * pager.itemsPerPage + $(this).closest("li.list-group-item-action").index()].no_joj;
              location.replace(`/edit-job-order/${no_jo}`);
              event.stopImmediatePropagation();
            })

            $('#myList').on('click', 'li.list-group-item-action', function(event) {
              // alert($(this).index());
              event.preventDefault();
              let no_jo = listJobOrder[pager.currentPage * pager.itemsPerPage + $(this).index()].no_joj;
              if (user.role === "Marketing") {
                location.replace(`/job-order/${no_jo}`);
              } else if (user.role === "Operational") {
                location.replace(`/approve-job-order/${no_jo}`);
              }
            })

            // $('#myList').on('click', '.list-group-item-action', async function(event) {
            //   console.log($(this).index());
            //   alert("link detail jo 1")
            // //   console.log($(this).index());
            // //   event.preventDefault();
            // //   let no_jo = listJobOrder[pager.currentPage * pager.itemsPerPage + $(this).index()].no_joj;
            // //   // console.log("no_jo is = ", no_jo);
            // //   // console.log($(this).data('wpurl'));
            // //   // event.originalEvent.currentTarget.href = `/job-order/${no_jo}`;
            // //   // console.log(event.originalEvent.currentTarget.href);
            // //   if (user.role === "Marketing") {
            // //     location.replace(`/job-order/${no_jo}`);
            // //   } else if (user.role === "Operational") {
            // //     location.replace(`/approve-job-order/${no_jo}`);
            // //   }
            // //   // return await fetch(`/job-order/${no_jo}`, {
            // //   //       method: "GET",
            // //   //       headers: {
            // //   //         "Content-Type": "application/json",
            // //   //       },
            // //   //     });
            // //   return false;
            // //   // event.preventDefault();
            // //   return;
            // });

            $('.pager .pagination').on('click', 'li:not(.prev):not(.next)', function() {
              $('.pager .pagination li').removeClass('active');
              $(this).not('.prev,.next').addClass('active');
              pager.currentPage = Number($(this).text()) - 1;
              bindList();
              return false;
            });

            $('.pager .pagination').on('click', 'li.prev', function() {
              // $('li.active').removeClass('active').prev().addClass('active');
              pager.prevPage();
              bindList();
              return false;
            });

            $('.pager .pagination').on('click', 'li.next', function() {
              // $('li.active').removeClass('active').next().addClass('active');
              pager.nextPage();
              bindList();
              return false;
            });


        });
    </script>
  </body>
</html>
